<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Â£∞ÊéßÁÉüËä± ¬∑ ÊçïËé∑Ê†áÁ≠æÈ°µÈü≥È¢ë ¬∑ Â¢ûÂº∫ÂÖºÂÆπ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #0a0f1e;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        canvas {
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 10;
            pointer-events: auto;
        }
        .control-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 99;
            background: rgba(10, 15, 30, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 48px;
            padding: 12px 20px;
            border: 1px solid rgba(255, 220, 150, 0.25);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            color: #ffecdd;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            font-size: 15px;
            pointer-events: auto;
            transition: 0.2s;
            border-left: 3px solid #ffaa66;
        }
        .control-panel:hover {
            background: rgba(20, 25, 45, 0.85);
            border-color: #ffbb77;
        }
        .control-panel label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .control-panel input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #ff8844;
            transform: scale(1);
            cursor: pointer;
            filter: drop-shadow(0 0 4px #ffaa55);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #5f6b7a;
            box-shadow: 0 0 5px currentColor;
            margin-left: 5px;
            transition: 0.2s;
        }
        .status-dot.active {
            background: #ffbb33;
            box-shadow: 0 0 12px #ffaa33;
        }
        .status-dot.error {
            background: #ff5555;
            box-shadow: 0 0 12px #ff3333;
        }
        .hint-text {
            font-size: 12px;
            color: #aaa;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .capture-btn {
            background: rgba(255, 140, 70, 0.25);
            border: 1px solid #ff9966;
            color: #ffdbbc;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(255,100,0,0.3);
            backdrop-filter: blur(4px);
        }
        .capture-btn:hover {
            background: #ff8844;
            color: #0a0f1e;
            border-color: #ffaa66;
            box-shadow: 0 0 15px #ff9933;
        }
        @media (max-width: 600px) {
            .control-panel {
                bottom: 16px;
                right: 16px;
                left: 16px;
                width: auto;
                border-radius: 40px;
                justify-content: space-around;
                padding: 10px 16px;
                gap: 10px;
            }
            .hint-text { max-width: 120px; }
        }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>

    <div class="control-panel" id="controlPanel">
        <button class="capture-btn" id="captureAudioBtn">üé¨ ÊçïËé∑Ê†áÁ≠æÈ°µÈü≥È¢ë</button>
        <label>
            <input type="checkbox" id="soundToggleCheckbox" disabled> üéµ Èü≥È¢ëÈ©±Âä®
        </label>
        <span class="status-dot" id="audioStatusDot" title="Èü≥È¢ëÁä∂ÊÄÅ"></span>
        <span class="hint-text" id="statusHint">Êú™ÊçïËé∑</span>
    </div>

    <script>
        (function() {
            "use strict";

            var FireworksEnhanced = function(canvasElem) {
                var self = this;

                var rand = function(rMi, rMa) {
                    return ~~(Math.random() * (rMa - rMi + 1) + rMi);
                };

                window.requestAnimFrame = (function() {
                    return window.requestAnimationFrame ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function(callback) { window.setTimeout(callback, 1000 / 60); };
                })();

                // Èü≥È¢ëÁõ∏ÂÖ≥
                self.audioCtx = null;
                self.isAudioReady = false;
                self.captureStream = null;
                self.audioSource = null;
                self.analyser = null;
                self.soundEnabled = false;
                self.lastSoundFire = 0;
                self.soundFireCooldown = 250;
                self.soundThreshold = 30;
                self.volumeAvg = 0;
                self.noiseBuffer = null;

                // DOM
                self.captureBtn = document.getElementById('captureAudioBtn');
                self.toggleCheckbox = document.getElementById('soundToggleCheckbox');
                self.statusDot = document.getElementById('audioStatusDot');
                self.statusHint = document.getElementById('statusHint');

                // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
                function initAudio() {
                    if (self.audioCtx) return;
                    try {
                        self.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        self.isAudioReady = true;
                        self.noiseBuffer = createNoiseBuffer(self.audioCtx);
                    } catch (e) {
                        console.warn("Web Audio not supported");
                        self.statusHint.textContent = "Web Audio ‰∏çÊîØÊåÅ";
                    }
                }
                initAudio();

                function createNoiseBuffer(ctx) {
                    const bufferSize = ctx.sampleRate * 0.25;
                    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                    const output = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                    return buffer;
                }

                function playExplodeSound() {
                    if (!self.audioCtx || !self.isAudioReady || !self.noiseBuffer) return;
                    if (self.audioCtx.state === 'suspended') {
                        self.audioCtx.resume().then(() => doPlay()).catch(() => {});
                    } else if (self.audioCtx.state === 'running') {
                        doPlay();
                    }
                    function doPlay() {
                        const source = self.audioCtx.createBufferSource();
                        source.buffer = self.noiseBuffer;
                        const gainNode = self.audioCtx.createGain();
                        source.connect(gainNode);
                        gainNode.connect(self.audioCtx.destination);
                        const now = self.audioCtx.currentTime;
                        gainNode.gain.setValueAtTime(0.25, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
                        source.start(now);
                        source.stop(now + 0.25);
                    }
                }

                // ----- ÊîπËøõÁöÑÊçïËé∑ÂáΩÊï∞ÔºàÂ§ÑÁêÜÂÖºÂÆπÊÄßÔºâ-----
                self.startCapture = async function() {
                    if (!self.audioCtx) {
                        self.statusHint.textContent = "Èü≥È¢ë‰∏ä‰∏ãÊñá‰∏çÂèØÁî®";
                        return;
                    }

                    self.stopCapture();

                    try {
                        // Á¨¨‰∏ÄÊ≠•ÔºöÂ∞ùËØï‰ªÖÈü≥È¢ëÊçïËé∑ÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                        let stream;
                        try {
                            stream = await navigator.mediaDevices.getDisplayMedia({
                                video: false,
                                audio: true   // ‰ΩøÁî® true ËÄå‰∏çÊòØÁ©∫ÂØπË±°ÔºåÊõ¥ÈÄöÁî®
                            });
                        } catch (err) {
                            // Â¶ÇÊûú‰∏çÊîØÊåÅ‰ªÖÈü≥È¢ëÔºåÂ∞ùËØïÂåÖÂê´ËßÜÈ¢ëÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
                            if (err.name === 'NotSupportedError' || err.name === 'TypeError') {
                                console.warn('‰ªÖÈü≥È¢ëÊçïËé∑‰∏çÊîØÊåÅÔºåÂ∞ùËØïÂåÖÂê´ËßÜÈ¢ëËΩ®ÈÅì');
                                stream = await navigator.mediaDevices.getDisplayMedia({
                                    video: true,   // ÂøÖÈ°ªÂåÖÂê´ËßÜÈ¢ë
                                    audio: true
                                });
                                // Â¶ÇÊûúÂæóÂà∞‰∫ÜËßÜÈ¢ëËΩ®ÈÅìÔºåÊàë‰ª¨ÂèØ‰ª•Â∞ÜÂÖ∂ÂøΩÁï•Ôºà‰∏çÂ§ÑÁêÜÔºâ
                                // ‰ΩÜÊ≥®ÊÑèÁî®Êà∑ÂèØËÉΩ‰ºöÁúãÂà∞ËßÜÈ¢ëÁîªÈù¢Ôºå‰ΩÜÊàë‰ª¨‰∏ç‰ºöÊ∏≤Êüì
                            } else {
                                throw err; // ÂÖ∂‰ªñÈîôËØØÁõ¥Êé•ÊäõÂá∫
                            }
                        }

                        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Èü≥È¢ëËΩ®ÈÅì
                        if (!stream || stream.getAudioTracks().length === 0) {
                            throw new Error("Êú™Ê£ÄÊµãÂà∞Èü≥È¢ëËΩ®ÈÅìÔºåËØ∑Á°Æ‰øùÂú®ÂàÜ‰∫´Êó∂ÂãæÈÄâ‚ÄúÂàÜ‰∫´Èü≥È¢ë‚Äù");
                        }

                        self.captureStream = stream;

                        // Á°Æ‰øùÈü≥È¢ë‰∏ä‰∏ãÊñáÂ§Ñ‰∫éËøêË°åÁä∂ÊÄÅ
                        if (self.audioCtx.state === 'suspended') {
                            await self.audioCtx.resume();
                        }

                        // ÂàõÂª∫Èü≥È¢ëÊ∫êÂπ∂ËøûÊé•Âà∞ÂàÜÊûêÂô®
                        self.audioSource = self.audioCtx.createMediaStreamSource(stream);
                        self.analyser = self.audioCtx.createAnalyser();
                        self.analyser.fftSize = 256;
                        self.audioSource.connect(self.analyser);
                        // ‰∏çËøûÊé• destination

                        // Êõ¥Êñ∞ UI
                        self.soundEnabled = true;
                        self.toggleCheckbox.checked = true;
                        self.toggleCheckbox.disabled = false;
                        self.statusDot.className = 'status-dot active';
                        self.statusHint.textContent = `ÊçïËé∑‰∏≠: ${stream.getAudioTracks()[0].label || 'Ê†áÁ≠æÈ°µÈü≥È¢ë'}`;

                        // ÁõëÂê¨ËΩ®ÈÅìÁªìÊùü‰∫ã‰ª∂
                        stream.getAudioTracks()[0].onended = () => {
                            self.stopCapture();
                            self.statusHint.textContent = 'Áî®Êà∑ÂÅúÊ≠¢ÂÖ±‰∫´';
                            self.statusDot.className = 'status-dot';
                            self.toggleCheckbox.checked = false;
                            self.toggleCheckbox.disabled = true;
                            self.soundEnabled = false;
                        };

                    } catch (err) {
                        console.error('ÊçïËé∑Â§±Ë¥•:', err);
                        // Âå∫ÂàÜÈîôËØØÁ±ªÂûãÔºåÁªôÁî®Êà∑ÂèãÂ•ΩÊèêÁ§∫
                        let errorMsg = 'ÊçïËé∑Â§±Ë¥•';
                        if (err.name === 'NotAllowedError' || err.message.includes('Permission denied')) {
                            errorMsg = 'Áî®Êà∑ÊãíÁªù‰∫ÜÂÖ±‰∫´ËØ∑Ê±Ç';
                        } else if (err.name === 'AbortError' || err.message.includes('cancelled')) {
                            errorMsg = 'ÂÖ±‰∫´Â∑≤ÂèñÊ∂à';
                        } else if (err.name === 'NotSupportedError' || err.message.includes('Not supported')) {
                            errorMsg = 'ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÊçïËé∑Èü≥È¢ëÔºåËØ∑Â∞ùËØïÈ∫¶ÂÖãÈ£éÊñπÊ°à';
                        } else {
                            errorMsg = err.message || 'Êú™Áü•ÈîôËØØ';
                        }
                        self.statusHint.textContent = errorMsg;
                        self.statusDot.className = 'status-dot error';
                        self.toggleCheckbox.checked = false;
                        self.toggleCheckbox.disabled = true;
                        self.soundEnabled = false;
                    }
                };

                self.stopCapture = function() {
                    if (self.audioSource) {
                        try { self.audioSource.disconnect(); } catch(e) {}
                        self.audioSource = null;
                    }
                    if (self.captureStream) {
                        self.captureStream.getTracks().forEach(track => track.stop());
                        self.captureStream = null;
                    }
                    self.analyser = null;
                    self.soundEnabled = false;
                    self.toggleCheckbox.checked = false;
                    self.toggleCheckbox.disabled = true;
                    self.statusDot.className = 'status-dot';
                    self.statusHint.textContent = 'Êú™ÊçïËé∑';
                };

                // ÁªëÂÆöUI
                self.setupUI = function() {
                    if (!self.captureBtn) return;
                    self.captureBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        self.startCapture();
                    });

                    if (self.toggleCheckbox) {
                        self.toggleCheckbox.addEventListener('change', function(e) {
                            // Â§çÈÄâÊ°ÜÁä∂ÊÄÅÊîπÂèòÊó∂Ôºå‰∏çÂÅöÈ¢ùÂ§ñÊìç‰ΩúÔºåÂè™ÊòØÂÖÅËÆ∏/Á¶ÅÊ≠¢Èü≥È¢ëÈ©±Âä®
                        });
                    }
                };

                // ----- ÂàùÂßãÂåñÁîªÂ∏ÉÂíåÁ≤íÂ≠êÂèÇÊï∞ (‰∏éÂéü‰ª£Á†ÅÁõ∏Âêå) -----
                self.init = function() {
                    self.canvas = canvasElem;
                    self.ctx = self.canvas.getContext('2d');
                    self.resizeCanvas();

                    self.particles = [];
                    self.fireworks = [];
                    self.mx = self.cw / 2;
                    self.my = self.ch / 2;

                    self.currentHue = rand(20, 50);

                    self.partCount = 200;
                    self.partSpeed = 7;
                    self.partSpeedVariance = 14;
                    self.partWind = 30;
                    self.partFriction = 3;
                    self.partGravity = 0.8;
                    self.hueMin = 0;
                    self.hueMax = 360;
                    self.fworkSpeed = 5;
                    self.fworkAccel = 9;
                    self.hueVariance = 45;
                    self.flickerDensity = 35;
                    self.showShockwave = true;
                    self.showTarget = false;
                    self.clearAlpha = 18;

                    self.lineWidth = 1.8;

                    self.bindCanvasEventsNative();
                    self.setupUI();

                    self.canvasLoop();

                    self.canvas.onselectstart = function() { return false; };
                };

                self.resizeCanvas = function() {
                    self.cw = window.innerWidth;
                    self.ch = window.innerHeight;
                    self.canvas.width = self.cw;
                    self.canvas.height = self.ch;
                    self.ctx.lineCap = 'round';
                    self.ctx.lineJoin = 'round';
                    self.ctx.lineWidth = self.lineWidth;
                };

                // Á≤íÂ≠êÁ≥ªÁªüÊñπÊ≥ï (ÂÆåÊï¥‰øùÁïôÔºåÈÅøÂÖçÈáçÂ§çÁØáÂπÖ)
                self.createParticles = function(x, y, hue) {
                    playExplodeSound();
                    var count = self.partCount;
                    while (count--) {
                        var speed = rand(Math.max(1, self.partSpeed - self.partSpeedVariance), self.partSpeed + self.partSpeedVariance);
                        self.particles.push({
                            x: x, y: y,
                            coordLast: [{x:x,y:y},{x:x,y:y},{x:x,y:y}],
                            angle: rand(0,360),
                            speed: speed,
                            friction: 1 - self.partFriction/100,
                            gravity: self.partGravity/2 + (Math.random()*0.2-0.1),
                            hue: rand(hue - self.hueVariance, hue + self.hueVariance),
                            brightness: rand(70,100),
                            alpha: rand(60,100)/100,
                            decay: rand(5,25)/1000,
                            wind: (rand(0,self.partWind)-self.partWind/2)/25,
                            lineWidth: self.lineWidth * rand(8,15)/10,
                            radius: rand(1,3)
                        });
                    }
                };

                self.updateParticles = function() { /* ÂêåÂâçÔºåÁï• */
                    var i = self.particles.length;
                    while (i--) {
                        var p = self.particles[i];
                        var radians = (p.angle * Math.PI) / 180;
                        var vx = Math.cos(radians) * p.speed;
                        var vy = Math.sin(radians) * p.speed;
                        p.speed *= p.friction;
                        p.coordLast[2].x = p.coordLast[1].x; p.coordLast[2].y = p.coordLast[1].y;
                        p.coordLast[1].x = p.coordLast[0].x; p.coordLast[1].y = p.coordLast[0].y;
                        p.coordLast[0].x = p.x; p.coordLast[0].y = p.y;
                        p.x += vx; p.y += vy; p.y += p.gravity;
                        p.angle += p.wind;
                        p.alpha -= p.decay;
                        if (p.x < 0 || p.x > self.cw) { p.angle = 180 - p.angle; if(p.x<0)p.x=2; if(p.x>self.cw)p.x=self.cw-2; p.speed*=0.6; }
                        if (p.y < 0 || p.y > self.ch) { p.angle = -p.angle; if(p.y<0)p.y=2; if(p.y>self.ch)p.y=self.ch-2; p.speed*=0.6; }
                        if (p.alpha < 0.01) self.particles.splice(i,1);
                    }
                };

                self.drawParticles = function() { /* ÂêåÂâçÔºåÁï• */
                    var i = self.particles.length;
                    while (i--) {
                        var p = self.particles[i];
                        var coordRand = rand(0,2);
                        self.ctx.beginPath();
                        self.ctx.moveTo(Math.round(p.coordLast[coordRand].x), Math.round(p.coordLast[coordRand].y));
                        self.ctx.lineTo(Math.round(p.x), Math.round(p.y));
                        self.ctx.closePath();
                        self.ctx.strokeStyle = `hsla(${p.hue}, 100%, ${p.brightness}%, ${p.alpha})`;
                        self.ctx.stroke();
                        if (self.flickerDensity > 0) {
                            var inverseDensity = 60 - self.flickerDensity;
                            if (rand(0,inverseDensity)===0) {
                                self.ctx.beginPath();
                                self.ctx.arc(Math.round(p.x), Math.round(p.y), rand(1,3), 0, 2*Math.PI);
                                self.ctx.closePath();
                                self.ctx.fillStyle = `hsla(${p.hue}, 100%, ${p.brightness}%, ${rand(50,100)/100})`;
                                self.ctx.fill();
                            }
                        }
                    }
                };

                self.createFireworks = function(startX, startY, targetX, targetY) {
                    var angle = Math.atan2(targetY - startY, targetX - startX);
                    self.fireworks.push({
                        x: startX, y: startY,
                        startX: startX, startY: startY,
                        hitX: false, hitY: false,
                        coordLast: [{x:startX,y:startY},{x:startX,y:startY},{x:startX,y:startY}],
                        targetX: targetX, targetY: targetY,
                        speed: self.fworkSpeed,
                        angle: angle,
                        shockwaveAngle: angle + 90 * (Math.PI/180),
                        acceleration: self.fworkAccel / 100,
                        hue: self.currentHue,
                        brightness: rand(70,100),
                        alpha: rand(70,100)/100,
                        lineWidth: self.lineWidth
                    });
                };

                self.updateFireworks = function() { /* ÂêåÂâçÔºåÁï• */
                    var i = self.fireworks.length;
                    while (i--) {
                        var f = self.fireworks[i];
                        var vx = Math.cos(f.angle) * f.speed;
                        var vy = Math.sin(f.angle) * f.speed;
                        f.speed *= 1 + f.acceleration;
                        f.coordLast[2].x = f.coordLast[1].x; f.coordLast[2].y = f.coordLast[1].y;
                        f.coordLast[1].x = f.coordLast[0].x; f.coordLast[1].y = f.coordLast[0].y;
                        f.coordLast[0].x = f.x; f.coordLast[0].y = f.y;
                        if (f.startX >= f.targetX) { if (f.x + vx <= f.targetX) { f.x = f.targetX; f.hitX = true; } else f.x += vx; }
                        else { if (f.x + vx >= f.targetX) { f.x = f.targetX; f.hitX = true; } else f.x += vx; }
                        if (f.startY >= f.targetY) { if (f.y + vy <= f.targetY) { f.y = f.targetY; f.hitY = true; } else f.y += vy; }
                        else { if (f.y + vy >= f.targetY) { f.y = f.targetY; f.hitY = true; } else f.y += vy; }
                        if (f.hitX && f.hitY) {
                            self.createParticles(f.targetX, f.targetY, f.hue);
                            self.fireworks.splice(i,1);
                        }
                    }
                };

                self.drawFireworks = function() { /* ÂêåÂâçÔºåÁï• */
                    self.ctx.globalCompositeOperation = 'lighter';
                    var i = self.fireworks.length;
                    while (i--) {
                        var f = self.fireworks[i];
                        var coordRand = rand(0,2);
                        self.ctx.beginPath();
                        self.ctx.moveTo(Math.round(f.coordLast[coordRand].x), Math.round(f.coordLast[coordRand].y));
                        self.ctx.lineTo(Math.round(f.x), Math.round(f.y));
                        self.ctx.closePath();
                        self.ctx.strokeStyle = `hsla(${f.hue}, 100%, ${f.brightness}%, ${f.alpha})`;
                        self.ctx.stroke();
                        if (self.showShockwave) {
                            self.ctx.save();
                            self.ctx.translate(Math.round(f.x), Math.round(f.y));
                            self.ctx.rotate(f.shockwaveAngle);
                            self.ctx.beginPath();
                            self.ctx.arc(0,0, 1*(f.speed/4), 0, Math.PI, true);
                            self.ctx.strokeStyle = `hsla(${f.hue}, 100%, ${f.brightness}%, ${rand(20,50)/100})`;
                            self.ctx.lineWidth = f.lineWidth;
                            self.ctx.stroke();
                            self.ctx.restore();
                        }
                    }
                    self.ctx.globalCompositeOperation = 'source-over';
                };

                self.bindCanvasEventsNative = function() {
                    window.addEventListener('resize', function() {
                        clearTimeout(self.resizeTimeout);
                        self.resizeTimeout = setTimeout(self.resizeCanvas.bind(self), 100);
                    });
                    self.canvas.addEventListener('touchstart', handleStart, { passive: false });
                    self.canvas.addEventListener('mousedown', handleStart);

                    function handleStart(e) {
                        e.preventDefault();
                        if (self.audioCtx && self.audioCtx.state === 'suspended') self.audioCtx.resume();
                        var clientX, clientY;
                        if (e.type === 'mousedown') { clientX = e.clientX; clientY = e.clientY; }
                        else { if(e.touches.length>0){ clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else return; }
                        self.mx = clientX; self.my = clientY;
                        self.currentHue = rand(self.hueMin, self.hueMax);
                        self.createFireworks(self.cw/2, self.ch, self.mx, self.my);

                        function handleMove(e) {
                            e.preventDefault();
                            var moveX, moveY;
                            if (e.type === 'mousemove') { moveX = e.clientX; moveY = e.clientY; }
                            else { if(e.touches.length>0){ moveX = e.touches[0].clientX; moveY = e.touches[0].clientY; } else return; }
                            self.mx = moveX; self.my = moveY;
                            self.currentHue = rand(self.hueMin, self.hueMax);
                            self.createFireworks(self.cw/2, self.ch, self.mx, self.my);
                        }
                        function handleEnd(e) {
                            e.preventDefault();
                            document.removeEventListener('mousemove', handleMove);
                            document.removeEventListener('mouseup', handleEnd);
                            document.removeEventListener('touchmove', handleMove, { passive: false });
                            document.removeEventListener('touchend', handleEnd, { passive: false });
                            document.removeEventListener('touchcancel', handleEnd, { passive: false });
                        }
                        document.addEventListener('mousemove', handleMove);
                        document.addEventListener('mouseup', handleEnd);
                        document.addEventListener('touchmove', handleMove, { passive: false });
                        document.addEventListener('touchend', handleEnd, { passive: false });
                        document.addEventListener('touchcancel', handleEnd, { passive: false });
                    }
                    self.canvas.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
                };

                // ‰∏ªÂæ™ÁéØ
                self.canvasLoop = function() {
                    requestAnimFrame(self.canvasLoop, self.canvas);
                    self.ctx.globalCompositeOperation = 'source-over';
                    self.ctx.fillStyle = 'rgba(0, 0, 0, ' + self.clearAlpha / 100 + ')';
                    self.ctx.fillRect(0, 0, self.cw, self.ch);

                    if (self.toggleCheckbox && self.toggleCheckbox.checked && self.analyser) {
                        const dataArray = new Uint8Array(self.analyser.frequencyBinCount);
                        self.analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                        let avg = sum / dataArray.length;
                        self.volumeAvg = avg;

                        if (avg > self.soundThreshold) {
                            const now = Date.now();
                            if (now - self.lastSoundFire > self.soundFireCooldown) {
                                self.lastSoundFire = now;
                                let targetX = rand(150, self.cw-150);
                                let targetY = rand(100, self.ch-200);
                                self.currentHue = rand(self.hueMin, self.hueMax);
                                self.createFireworks(self.cw/2, self.ch, targetX, targetY);
                                if (avg > 120) {
                                    setTimeout(() => {
                                        self.currentHue = rand(self.hueMin, self.hueMax);
                                        self.createFireworks(self.cw/2, self.ch, rand(150,self.cw-150), rand(100,self.ch-200));
                                    }, 30);
                                }
                            }
                        }
                    }

                    self.updateFireworks();
                    self.updateParticles();
                    self.drawFireworks();
                    self.drawParticles();
                };

                self.init();
            };

            var canvas = document.getElementById('fireworksCanvas');
            var fworks = new FireworksEnhanced(canvas);
            window.fworks = fworks;
        })();
    </script>
</body>
</html>