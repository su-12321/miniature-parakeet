{% extends 'blog/base.html' %}
{% load static %}

{% block title %}与 {{ other_user.username }} 的私聊 - 我的博客{% endblock %}

{% block extra_css %}
<style>
    /* 保留原有样式，可根据需要添加背景图片 */
    body {
        background-color: #f0f2f5;
    }
    .chat-messages {
        background-color: #e5ddd5; /* 类似 WhatsApp 的背景 */
    }
    .message-self .message-content {
        background-color: #dcf8c6;
        color: #000;
    }
    .message-other .message-content {
        background-color: #ffffff;
        color: #333;
    }
    /* 其余样式保持不变 */
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    .message {
        margin-bottom: 1rem;
        max-width: 70%;
    }
    .message-self {
        margin-left: auto;
    }
    .message-other {
        margin-right: auto;
    }
    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
        word-wrap: break-word;
    }
    .message-self .message-content {
        border-bottom-right-radius: 0.25rem;
    }
    .message-other .message-content {
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 0.25rem;
    }
    .message-header {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.8;
    }
    .message-self .message-time {
        text-align: right;
        color: rgba(0, 0, 0, 0.6);
    }
    .chat-input {
        border-top: 1px solid #dee2e6;
        padding: 1rem;
        background-color: white;
    }
    .typing-indicator {
        height: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .typing-indicator.show {
        opacity: 1;
    }
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6c757d;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    .empty-chat {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .empty-chat i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .unread-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 0.7rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card chat-container">
        <!-- 聊天头部 -->
        <div class="chat-header position-relative">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="{% url 'private_chat_list' %}" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="me-3 position-relative">
                        {% if other_user.profile.avatar %}
                        <img src="{{ other_user.profile.avatar.url }}"
                             class="rounded-circle border"
                             width="40" height="40"
                             alt="{{ other_user.username }}的头像"
                             style="object-fit: cover;">
                        {% else %}
                        <img src="/media/avatars/default.png"
                             class="rounded-circle border"
                             width="40" height="40"
                             alt="{{ other_user.username }}的头像"
                             style="object-fit: cover;">
                        {% endif %}
                    </div>
                    <div>
                        <h5 class="mb-0">{{ other_user.username }}</h5>
                        {% if other_user.first_name or other_user.last_name %}
                            <small class="text-muted">
                                {{ other_user.first_name }} {{ other_user.last_name }}
                            </small>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <a href="{% url 'private_chat_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list"></i> 会话列表
                    </a>
                </div>
            </div>
        </div>

        <!-- 消息区域 -->
        <div class="chat-messages" id="chatMessages">
            <!-- 空状态，由 JavaScript 填充 -->
            <div class="empty-chat" id="emptyChatMessage">
                <i class="fas fa-comments"></i>
                <h5 class="mt-3">还没有消息</h5>
                <p class="text-muted">发送第一条消息开始对话</p>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="chat-input">
            <form id="messageForm">
                <div class="input-group">
                    <textarea name="content" id="id_content" class="form-control"
                              rows="1" placeholder="输入消息..." required></textarea>
                    <button type="submit" class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i> 发送
                    </button>
                </div>
                <small class="text-muted mt-1 d-block">
                    按 Enter 发送，Shift+Enter 换行
                </small>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const otherUserId = {{ other_user.id }};
    const currentUserId = {{ request.user.id }};

    let chatSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    let heartbeatInterval = null;

    // 连接 WebSocket
    function connectWebSocket() {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) return;

        chatSocket = new WebSocket('ws://' + window.location.host + '/ws/private/' + otherUserId + '/');

        chatSocket.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0; // 重置重连计数
            // 启动心跳
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({'type': 'ping'}));
                }
            }, 30000); // 每30秒发送一次ping
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'message') {
                appendMessage(data);
            } else if (data.type === 'pong') {
                // 心跳响应，无需处理
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket closed:', e.code, e.reason);
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            // 尝试重连
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 3000); // 3秒后重连
            } else {
                BlogUtils.showNotification('连接失败，请刷新页面重试', 'danger');
            }
        };

        chatSocket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    // 发送消息
    function sendMessage(message) {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({'type': 'message', 'message': message}));
            return true;
        } else {
            BlogUtils.showNotification('连接已断开，请稍后重试', 'warning');
            return false;
        }
    }

    // 追加消息到聊天区域
    function appendMessage(data) {
        const isSelf = (data.sender_id === currentUserId);
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSelf ? 'message-self' : 'message-other'}`;
        messageDiv.innerHTML = `
            <div class="message-header">${isSelf ? '你' : data.sender_username}</div>
            <div class="message-content">${escapeHtml(data.message)}</div>
            <div class="message-time">${new Date(data.timestamp).toLocaleTimeString()}</div>
        `;
        document.getElementById('chatMessages').appendChild(messageDiv);
        scrollToBottom();
    }

    // 加载历史消息（增量）
    let lastMessageId = null;
    function loadMessages() {
        let url = '/api/private-chat/messages/' + otherUserId + '/';
        if (lastMessageId) {
            url += '?last_id=' + lastMessageId;
        }
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        appendMessage({
                            sender_id: msg.sender_id,
                            sender_username: msg.sender_username,
                            message: msg.content,
                            timestamp: msg.created_at
                        });
                    });
                    lastMessageId = data.messages[data.messages.length - 1].id;
                    // 隐藏空状态
                    document.getElementById('emptyChatMessage').style.display = 'none';
                }
            })
            .catch(error => console.error('加载消息失败:', error));
    }

    // 安全转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 滚动到底部
    function scrollToBottom() {
        const container = document.getElementById('chatMessages');
        container.scrollTop = container.scrollHeight;
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        loadMessages(); // 初次加载所有消息

        // 表单提交
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('id_content');
            const message = input.value.trim();
            if (message) {
                if (sendMessage(message)) {
                    input.value = '';
                }
            }
        });

        // 输入框高度自适应
        const input = document.getElementById('id_content');
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    });

    // 页面可见性变化时重连
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // 页面隐藏时可以保持连接
        } else {
            // 页面显示时，如果连接已关闭，重新连接
            if (!chatSocket || chatSocket.readyState === WebSocket.CLOSED) {
                connectWebSocket();
            }
        }
    });

    // 页面关闭前清理
    window.addEventListener('beforeunload', function() {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.close();
        }
        if (heartbeatInterval) clearInterval(heartbeatInterval);
    });
</script>
{% endblock %}